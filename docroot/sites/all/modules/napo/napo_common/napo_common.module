<?php
/**
 * @file
 * Code for the Napo Common feature.
 */

include_once 'napo_common.features.inc';

/**
 * Implments hook_form_FORM_ID_alter().
 */
function napo_common_form_chosen_admin_settings_alter(&$form, $form_state) {
  // Add options to chosen 30.
  $form['chosen_minimum_single']['#options']['30'] = '30';
  $form['chosen_minimum_multiple']['#options']['30'] = '30';
}

/**
 * Implements hook_node_submit().
 */
function napo_common_node_submit($node, $form, &$form_state) {
  // Add default alias for translations as the english alias (if one exists).
  $entity_trans_form = !empty($form_state['entity_translation']);
  if ($entity_trans_form && $form_state['entity_translation']['is_translation'] === TRUE
    && empty($form_state['values']['path']['alias'])) {
    $path = path_load(array('source' => 'node/' . $node->nid, 'language' => 'en'));
    if (!empty($path)) {
      $node->path['alias'] = $path['alias'];
    }
  }
}

/**
 * Implements hook_node_view().
 *
 * Handle the case when the current language does
 * not match content node language.
 */
function napo_common_node_view($node, $view_mode, $langcode) {
  global $language;

  // Node Moderation State is not Published
  if (workbench_moderation_node_type_moderated($node->type) &&
    (!isset($node->workbench_moderation['published']) || $node->workbench_moderation['published']->current != 1)) {
    return;
  }

  $redirectId = variable_get('no_translation_nid', '248');
  $exceptions = explode(PHP_EOL, variable_get('no_translation_exceptions'));
  $exceptions_types = explode(PHP_EOL, variable_get('no_translation_type_exceptions'));

  array_walk($exceptions, function(&$value, $index) {
    $value = trim($value);
  });

  array_walk($exceptions_types, function(&$value, $index){
    $value = trim($value);
  });

  $no_exception = (!in_array($node->nid, $exceptions) && !in_array($node->type, $exceptions_types));

  if ($view_mode == 'full' && $no_exception && !isset($_GET['orig_lng'])) {
    // If current language does not match content node language.
    if (!empty($node->language) && $node->language != $language->language && $node->nid != $redirectId) {
      // Lookup translations for current node
      if(!napo_common_has_translation($node->nid, $language)) {
        // Redirect to a static page if there's not a translation
        // in the currently active language.
        $nodeLanguage = $language->language;
        if (!napo_common_has_translation($redirectId, $language)) {
          // Uncomment after static page (No translation available) translation
          //$nodeLanguage = 'en';
        }
        // Redirect to no translation available page.
        drupal_goto(drupal_get_path_alias('node/'.$redirectId, $nodeLanguage),
          array(
            'query' => array('destination' => 'node/'.$node->nid),
            'language' => (object)array('language' => $nodeLanguage),
            'prefix' => $nodeLanguage.'/',
          )
        );
      }
    }
  }
}

/**
 * Implements hook_field_language_alter().
 * Performs language fallback for requests that have orig_lng as parameter
 */
function napo_common_field_language_alter(&$display_language, $context) {
  $entity = $context['entity'];
  $entity_type = $context['entity_type'];
  $fallback_language = 'en';
  if(isset($_GET['orig_lng'], $entity->nid) && $entity->nid == arg(1) && $entity_type == 'node') {
    if(preg_match('/[a-z]{2}/', $_GET['orig_lng'])) {
      $fallback_language = $_GET['orig_lng'];
    }
    locale_field_language_fallback($display_language, $entity, $fallback_language);
  }
}

/**
 * Check if a node has translation for a specified language
 */
function napo_common_has_translation($nid, $language) {
  $hasTranslation = FALSE;
  $node = node_load($nid);
  if(!$node) {
    return FALSE;
  }
  $translations = $node->translations->data;

  if(isset($translations[$language->language])) {
    $hasTranslation = TRUE;
  }
  return $hasTranslation;
}

/**
 * Implements hook_block_info().
 */
function napo_common_block_info() {
  $blocks = array();
  $blocks['no_translation'] = array(
    'info' => t('Translation not available'),
  );
  $blocks['page_not_found'] = array(
    'info' => t('Page not found'),
  );

  $blocks['napo_print_friendly'] = array(
    'info' => t('Print friendly'),
    'status' => 1,
    'visibility' => BLOCK_VISIBILITY_NOTLISTED,
    'region' => 'header_top_bar',
  );

  return $blocks;
}

/**
 * Implements hook_block_configure().
 */
function napo_common_block_configure($delta = '') {
  $form = array();

  switch($delta) {
    case 'no_translation':
      // No translation node Id
      $form['no_translation_nid'] = array(
        '#type' => 'textfield',
        '#title' => 'No translation page nid',
        '#default_value' => variable_get('no_translation_nid', '248'),
      );
      $form['no_translation_exceptions'] = array(
        '#type' => 'textarea',
        '#title' => 'Exceptions - node IDs',
        '#description' => "IDs for which the rule doesn't apply. Enter one node ID per line.",
        '#default_value' => variable_get('no_translation_exceptions'),
      );
      $form['no_translation_type_exceptions'] = array(
        '#type' => 'textarea',
        '#title' => 'Exceptions - content types',
        '#description' => "Content types for which the rule doesn't apply. Enter one content type per line.",
        '#default_value' => variable_get('no_translation_type_exceptions'),
      );
      break;

    case 'page_not_found':
      // Page not found text.
      $form['page_not_found_text'] = array(
        '#type' => 'textfield',
        '#title' => 'Page not found text',
        '#default_value' => variable_get('page_not_found_text',
          t("OOPS!<br />Sorry, we can't find what<br />you are looking for")),
      );
      break;
  }
  return $form;
}

/**
 * Implements hook_block_save().
 */
function napo_common_block_save($delta = '', $edit = array()) {
  switch($delta) {
    case 'no_translation':
      // Saving static page nid.
      variable_set('no_translation_nid', $edit['no_translation_nid']);
      // Saving exceptions
      variable_set('no_translation_exceptions', $edit['no_translation_exceptions']);
      // Saving content types exceptions
      variable_set('no_translation_type_exceptions', $edit['no_translation_type_exceptions']);
      break;

    case 'page_not_found':
      // Saving page not found text.
      variable_set('page_not_found_text', $edit['page_not_found_text']);
      break;
  }
}

/**
 * Implements hook_block_view().
 */
function napo_common_block_view($delta = '') {
  $block = array();

  switch($delta) {
    case 'no_translation' :
      $block['content'] = drupal_get_form('napo_common_no_translation_form');
      break;

    case 'page_not_found' :
      $block['content'] = napo_common_page_not_found_content();
      break;

    case 'napo_print_friendly' :
      $block['subject'] = "<none>";
      $block['content'] = theme('napo_print_friendly_block');
      break;
  }

  return $block;
}

/**
 * Implements hook_node_access().
 */
function napo_common_node_access($node, $op, $account) {
  // Deny access for content with future published date.
  if ($op == 'view' && !user_access('view all unpublished content')) {
    if (!empty($node->field_publication_date)) {
      $wrapper = entity_metadata_wrapper('node', $node);
      $publication_date = $wrapper->field_publication_date->value();
      if ($publication_date > time()) {
        return NODE_ACCESS_DENY;
      }
    }
  }
  return NODE_ACCESS_IGNORE;
}

function napo_common_no_translation_form($form, &$form_state) {
  global $base_url, $language;
  $form = $available = array();
  if (empty($_REQUEST['destination'])) {
    return;
  }
  $nid = str_replace('node/', '', $_REQUEST['destination']);
  if (!$node = node_load($nid)) {
    return;
  }

  // Get node translations.
  $translations = array_keys($node->translations->data);
  sort($translations);
  // Get installed languages.
  $installed = language_list();

  // Set an array with available translations and languages names.
  foreach ($translations as $lng) {
    if (isset($installed[$lng])) {
      $available[$lng] = $installed[$lng]->native;
    }
  }

  // Available translations
  $form['available_languages'] = array(
    '#type' => 'select',
    '#title' => t('See this page in other language'),
    '#empty_option' => t('Select translation'),
    '#options' => $available,
    '#attributes' => array(
      'class' => array('lang-dropdown-select-element'),
    ),
  );

  $form['link_to_home'] = array(
    '#type' => 'markup',
    '#markup' =>
      "<div class = 'page_not_found_front'>".
      "<label>".t('Try this instead')."</label>".
      l(t('back to home'), '<front>').
      "</div>",
  );

  // Redirect node translations.
  foreach ($available as $lngCode => $lngValue) {
    $form[$lngCode] = array(
      '#type' => 'hidden',
      '#default_value' => '/'.$language->language.'/'.drupal_get_path_alias('node/'.$nid).'?orig_lng='.$lngCode,
    );
  }

  // URL of the page that has no translation
  $form['no_translation_request'] = array(
    '#type' => 'hidden',
    '#default_value' => $base_url.'/en/'.drupal_get_path_alias('node/'.$nid),
  );

  // Send mail button
  /*
  $form['no_translation_mail'] = array(
    '#type' => 'submit',
    '#prefix' => t('Help us: Tell us this page is not available in your language '),
    '#value' => 'Send',
  );
  */
  return $form;
}


/**
 * Form submit handler
 */
/*
function napo_common_no_translation_form_submit($form, &$form_state) {
  $site_email = variable_get('site_mail', ini_get('sendmail_from'));

  drupal_mail('napo_common', 'no_translation', $site_email, language_default(), $form_state);
  drupal_set_message(t('The mail has been submitted. Thank you!'));
  //redirect to home page
  drupal_goto('<front>');
}
*/

/**
 * Implements hook_mail().
 *
 * {@inheritdoc}
 */
function napo_common_mail($key, &$message, $params) {
  global $base_url;

  switch($key) {
    case 'no_translation':
      $message['subject'] = t('No translation report');
      $message['body'][] = 'The following page does not have all the translations created: '.$params['values']['no_translation_request'];
      break;
  }

  if (isset($params['node'])) {
    $node = $params['node'];
    $subject = 'A node was updated';
    if ($node->is_new) {
      $subject = 'A new node was created';
    }
    $body = 'Dear [user:name],<br />
      The following node was created/updated: <a href = "'.url('node/'.$node->nid, array('absolute' => TRUE)).'">'.$node->title.'</a><br />
      Thank you,';
    $message['subject'] = token_replace($subject, $params);
    $message['body'][] = token_replace($body, $params);
  }
}

/**
 * Implements hook_webform_select_options_info().
 *
 * See webform/webform.api.php for further information on
 * this hook in the Webform API.
 */
function napo_common_webform_select_options_info() {
  $items = array();
  $items['available_languages'] = array(
    'title' => t('Languages'),
    'options callback' => 'napo_common_webform_pre_build_list_languages',
  );

  return $items;
}

/**
 * Build an options list (available languages)
 * to be used with webforms select list.
 */
function napo_common_webform_pre_build_list_languages() {
  $available_languages = array();
  $languages = osha_language_list(TRUE);
  foreach($languages as $key => $language) {
    $available_languages[$key] = $language->native;
  }

  return $available_languages;
}

/**
 * Page not found content.
 */
function napo_common_page_not_found_content() {
  // Intro text.
  $content = "<div class = 'page_not_found_intro'>";
  $content .= variable_get('page_not_found_text', t("OOPS!<br />Sorry, we can't find what<br />you are looking for"));
  $content .= '</div>';

  // Search block.
  $content .= "<div class = 'page_not_found_search'>";
  $search_block = module_invoke('search', 'block_view');
  $content .= '<div>' . t('Try one of there instead:') . '</div>';
  $content .= render($search_block);
  $content .= '</div>';

  // Frontpage link.
  $content .= "<div class = 'page_not_found_front'>";
  $content .= l(t('back to home'), '<front>');
  $content .= '</div>';

  return $content;
}

/**
 * Implements hook_theme().
 */
function napo_common_theme() {
  return array(
    'napo_print_friendly_block' => array(),
  );
}

// Create a theme function that can be overridden by other theme developers.
function theme_napo_print_friendly_block() {
  // Add js and css
  $content = array(
    '#attached' => array(
      'js' => array(
        array(
          'data' => drupal_get_path('module', 'napo_common') . '/js/napo_print_friendly.js',
          'type' => 'file',
        )
      ),
    ),
  );

  $content['#markup'] = t('Print friendly:');
  $content['#markup'] .= '&nbsp;<a href="javascript:if(window.print)window.print();"><span class="glyphicon glyphicon-print"></span></a>';

  return render($content);
}

/**
 * Implements hook_node_insert().
 *
 * {@inheritdoc}
 */
function napo_common_node_insert($node) {
  napo_common_content_send_mail($node);
}

/**
 * Implements hook_node_update().
 *
 * {@inheritdoc}
 */
function napo_common_node_update($node) {
  napo_common_content_send_mail($node);
}

/**
 * Send email notification to all admin users
 */
function napo_common_content_send_mail($node) {
  $users = napo_common_get_users_by_role('administrator');
  OshaWorkflowNotifications::sendEmail($users, array('node' => $node), 'napo_common', 'osha_workflow_notification');
}

/**
 * Get users by role
 */
function napo_common_get_users_by_role ($role_name){
  $role = user_role_load_by_name($role_name);
  $uids = db_select('users_roles', 'ur')
    ->fields('ur', array('uid'))
    ->condition('ur.rid', $role->rid, '=')
    ->execute()
    ->fetchCol();
  $users = user_load_multiple($uids);

  return $users;
}
